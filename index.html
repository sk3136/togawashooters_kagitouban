<!DOCTYPE html>
<!--lang="ja"言語を日本語に設定する（これがないとブラウザが言語を間違えることがある）-->
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>外ヶ輪シューターズ鍵当番表</title>
<script>
    var now = new Date();
    var year = now.getFullYear();
    var month = now.getMonth() + 1;
    var date = now.getDate();
    var dayOfWeek = now.getDay();
    var dayOfWeek_kanji = ['日','月','火','水','木','金','土'];
    var impossible = [];
    var a = [];
    var b = [];
    var c = [];
    var d = [];
    var member_day = [a, b, c, d];
    var member = ['a','b','c','d'];
    var count = 0;
    window.onload = function addOption() {
        document.getElementById('month').textContent = month;
        document.getElementById('month_table').textContent = month;
        document.getElementById('month+1').textContent = month + 1;
        document.getElementById('impossible').textContent = member[0];
        var div_create = document.getElementById("create");
        div_create.style.display = 'none';
        let calendar = document.getElementById('calendar');
        for (var j = 0; j < 4; j++) {
            let newRow = calendar.insertRow();
            for (var i = 1 + j * 7; i < 8 + j * 7; i++) {
                let newCell = newRow.insertCell();
                let newText = document.createTextNode(i);
                newCell.appendChild(newText);
                // newCellにid（i）を付与する　setAttribute('付与する属性の名前',属性の中身);　setAttribute('idを',iにする')
                newCell.setAttribute('id',i);
                newCell.onclick = function() {
                    // this(newCell)のクラスをredに変える　クラスがついているならクラスを無くす
                    this.classList.toggle("red");
                }
            }
        }
    }
    function redday() {
        var red = document.getElementsByClassName("red");
        var div = document.getElementById("div");
        var div_create = document.getElementById("create");
        impossible = [];
        for (var i = 0; i < red.length; i++) {
            impossible.push(red[i].id);
            member_day[count].push(impossible);
            impossible = [];
        }
        count = count + 1;
        for (var i = red.length - 1; i >= 0; i--) {
            // remove 要素からクラスを削除する
            red[i].classList.remove("red");
        }
        if (member_day.length == count) {
            div.style.display = 'none';
            div_create.style.display = 'block';
        }
        document.getElementById('impossible').textContent = member[count];
        /*alert(count)
        alert(member_day[count - 1])*/
    }
    function restart() {
        var div = document.getElementById("div");
        var div_create = document.getElementById("create");
        div.style.display = 'block';
        div_create.style.display = 'none';
        document.getElementById('impossible').textContent = member[0];
        impossible = [];
        a = [];
        b = [];
        c = [];
        d = [];
        member_day = [a, b, c, d];
        count = 0;
    }
    function calendar() {
        var div_create = document.getElementById('create');
        var equal = false;
        var last_monthday = '';
        if (month == 1 || month == 3 || month == 5 || month == 7 || month == 8 || month == 10 || month == 12) {
            last_monthday = 31;
        } else if (month == 4 || month == 6 || month == 9 || month == 11) {
            last_monthday = 30;
        } else if (year % 4 == 0 && year % 100 != 0 || year % 400 == 0) {
            last_monthday = 29;
        } else {
            last_monthday = 28;
        }
        // while文　条件式がtrueの間繰り返す　この場合equalがfalseの間繰り返す
        while (equal == false) {
            var touban = [];
            var random_count = [0, 0, 0, 0];
            for (var i = 0; i < last_monthday; i++) {
                var possible = [0, 1, 2, 3];
                for (var k = member_day.length - 1; k >= 0; k--) {
                    for (var j = 0; j < member_day[k].length; j++) {
                        alert(member_day[k][j])
                        alert(member_day)
                        if (i + 1 == member_day[k][j]) {
                            // splice(何番目の要素から,いくつ削除する)
                            possible.splice(k,1);
                            break;
                        }
                    }
                }
                if (possible.length == 0) {
                    alert('全員が当番に出られない日があります。やり直してください')
                    restart();
                    reload();
                }
                // Math.floor　小数点以下を切り捨て　Math.random() 0からpossible.length未満の値の整数の乱数を作る
                var random = Math.floor(Math.random() * possible.length);
                // ランダムに選ばれた0~possible.length未満の値の整数をtoubanに追加
                touban.push(possible[random]);
                // メンバーの選ばれた日数を数える
                random_count[possible[random]]++
            }
            for (var i = 0; i < random_count.length; i++) {
                if (random_count[i] == Math.floor(last_monthday/member.length) || random_count[i] == Math.floor(last_monthday/member.length) + 1) {
                    equal = true;
                } else {
                    equal = false;
                    break;
                }
            }
        }
        for (var i = 0; i < last_monthday; i++) {
            let table = document.getElementById('table');
            let newRow = table.insertRow();
            let newCell = newRow.insertCell();
            let newCell_2 = newRow.insertCell();
            var dayOfWeek_now = new Date(year, month - 1, i + 1);
            var dayOfWeek_answer = dayOfWeek_now.getDay();
            var dayOfWeek_indication = '(' + dayOfWeek_kanji[dayOfWeek_answer] + ')';
            let newText = document.createTextNode(i + 1 + dayOfWeek_indication);
            let newText_2 = document.createTextNode(member[touban[i]]);
            newText.value = i + 1;
            newCell.appendChild(newText);
            newCell_2.appendChild(newText_2);
            table.style.display = 'inline-block';
            div_create.style.display = 'none';
        }
        /*for (var i = 0; i < 28; i++) {
            let table = document.getElementById('table');
            let newRow = table.insertRow();
            let newCell = newRow.insertCell();
            let newCell_2 = newRow.insertCell();
            var dayOfWeek_now = new Date(year, month - 1, i + 1);
            var dayOfWeek_answer = dayOfWeek_now.getDay();
            var dayOfWeek_indication = '(' + dayOfWeek_kanji[dayOfWeek_answer] + ')';
            let newText = document.createTextNode(i + 1 + dayOfWeek_indication);
            let newText_2 = document.createTextNode(member[touban[i]]);
            newText.value = i + 1;
            newCell.appendChild(newText);
            newCell_2.appendChild(newText_2);
            table.style.display = 'inline-block';
            div_create.style.display = 'none';
        }*/
    }
</script>
<style>
body {
    font-family: sans-serif;
    margin: 0px;
    text-align: center;
}
h1 {
    margin: 0px;
}
table {
    margin-top: 10px;
    border-collapse: collapse;
    font-size: 20px;
    display: none;
}
th {
    border:1px rgb(158, 158, 158) solid;
}
td {
    border:1px rgb(158, 158, 158) solid;
    background-color: #ffffff;
}
button {
    font-size: 20px;
    display: block;
    margin: auto;
}
p {
    font-size: 30px;
    margin: 0px;
}
.calendar {
    display: inline-block;
    font-size: 30px;
}
.red {
    background-color: #ff0000;
}
</style>
</head>
<body>
<h1>外ヶ輪シューターズ<br>鍵当番表</h1>
<div id="div">
<p><a id="month"></a>月</p>
<p><a id="impossible"></a>さんの不可日</p>
<table id="calendar" class="calendar">
    <tr>
        <th>日</th>
        <th>月</th>
        <th>火</th>
        <th>水</th>
        <th>木</th>
        <th>金</th>
        <th>土</th>
    </tr>
</table>
<button id="registration" onclick="redday()">登録</button>
</div>
<div id="create">
<button onclick="calendar()">作成</button>
</div>
<table id="table">
    <tr>
        <th>日（曜日）</th>
        <th><a id="month_table"></a>月</th>
    </tr>
</table>
<table>
    <tr>
        <th>日（曜日）</th>
        <th><a id="month+1"></a>月</th>
    </tr>
</table>
</body>
</html>
